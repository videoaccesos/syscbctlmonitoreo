<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Phone - Asistentes Inteligentes</title>
    <script src="jssip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        /* Contenedor principal con dise√±o moderno */
        .phone-wrapper {
            position: fixed;
            right: -320px;
            top: 50%;
            transform: translateY(-50%);
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 9999;
        }

        .phone-wrapper.open {
            right: 20px;
        }

        /* Tab estilo Access Bot con headset */
        .phone-tab {
            position: absolute;
            left: -60px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 140px;
            background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
            border-radius: 20px 0 0 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: -5px 0 20px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
            gap: 10px;
        }

        .phone-tab::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .phone-tab:hover::before {
            animation: shine 0.5s ease;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .phone-tab:hover {
            width: 65px;
            left: -65px;
            box-shadow: -5px 0 30px rgba(255, 107, 53, 0.5);
        }

        /* √çcono de headset SVG */
        .headset-icon {
            width: 35px;
            height: 35px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .tab-text {
            color: white;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        /* Animaci√≥n de llamada entrante */
        .phone-wrapper.ringing .phone-tab {
            animation: pulse 1s ease-in-out infinite;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        @keyframes pulse {
            0%, 100% { 
                transform: translateY(-50%) scale(1);
                box-shadow: -5px 0 20px rgba(239, 68, 68, 0.5);
            }
            50% { 
                transform: translateY(-50%) scale(1.05);
                box-shadow: -5px 0 40px rgba(239, 68, 68, 0.8);
            }
        }

        .phone-container {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            width: 320px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* Header estilo Access Bot */
        .phone-header {
            background: linear-gradient(135deg, #1e1b4b 0%, #2B2D6E 100%);
            color: white;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        .phone-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,165,0,0.1) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-30px, -30px) rotate(120deg); }
            66% { transform: translate(30px, -30px) rotate(240deg); }
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* √çcono de puerta estilo Access Bot */
        .logo-door {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
            border-radius: 8px;
            position: relative;
            box-shadow: 0 3px 10px rgba(255,107,53,0.3);
            overflow: hidden;
        }

        .logo-door::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 8px;
            width: 16px;
            height: 20px;
            background: white;
            border-radius: 2px 2px 0 0;
            transform-origin: left center;
            animation: doorOpen 3s ease-in-out infinite;
        }

        .logo-door::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 20px;
            width: 3px;
            height: 3px;
            background: #FF6B35;
            border-radius: 50%;
        }

        @keyframes doorOpen {
            0%, 70%, 100% { transform: rotateY(0deg); }
            80%, 90% { transform: rotateY(-25deg); }
        }

        .logo-text h1 {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .logo-text span {
            font-size: 9px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            width: 32px;
            height: 32px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            font-size: 11px;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 12px;
            width: fit-content;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239,68,68,0.5);
        }

        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16,185,129,0.5);
        }

        /* Panel de Control de Audio mejorado */
        .audio-controls {
            background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%);
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            border-bottom: 0px solid #e5e7eb;
        }

        .audio-controls.active {
            padding: 15px;
            max-height: 300px;
            border-bottom: 1px solid #e5e7eb;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .audio-control-item {
            margin-bottom: 12px;
        }

        .audio-control-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .audio-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
            position: relative;
        }

        .audio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255,107,53,0.3);
            transition: all 0.2s ease;
        }

        .audio-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 12px rgba(255,107,53,0.5);
        }

        .audio-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(255,107,53,0.3);
        }

        .volume-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 20px;
        }

        .volume-bar {
            width: 3px;
            background: #e5e7eb;
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .volume-bar.active {
            background: linear-gradient(to top, #FF6B35, #FFA500);
        }

        .mute-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .mute-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .mute-button.muted {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .mute-icon {
            font-size: 18px;
        }

        /* Display mejorado */
        .phone-display {
            padding: 15px;
            background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .phone-number {
            font-size: 22px;
            color: #1e1b4b;
            font-weight: 400;
            letter-spacing: 2px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .call-info {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .call-info.active {
            display: flex;
        }

        .call-timer {
            font-size: 18px;
            color: #1e1b4b;
            font-weight: 600;
        }

        .call-status {
            font-size: 12px;
            color: #64748b;
        }

        /* Tabs de navegaci√≥n */
        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .nav-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #64748b;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-tab.active {
            color: #FF6B35;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #FF6B35;
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }

        .nav-tab.active::after {
            transform: scaleX(1);
        }

        .nav-tab-icon {
            font-size: 18px;
        }

        /* Contenido de tabs */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dialpad moderno */
        .dialpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
            background: white;
        }

        .dial-btn {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            font-size: 20px;
            font-weight: 500;
            color: #1e1b4b;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .dial-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,107,53,0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .dial-btn:hover::before {
            width: 100px;
            height: 100px;
        }

        .dial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #FF6B35;
        }

        .dial-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .dial-btn .letters {
            font-size: 9px;
            color: #94a3b8;
            margin-top: 2px;
            text-transform: uppercase;
        }

        /* Botones de acci√≥n reorganizados */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            padding: 15px;
            background: #f8fafc;
            align-items: center;
        }

        .action-btn {
            width: 100%;
            height: 48px;
            border-radius: 12px;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .action-btn:hover::before {
            opacity: 1;
        }

        .delete-btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 4px 12px rgba(100,116,139,0.3);
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100,116,139,0.4);
        }

        .audio-toggle-btn {
            background: linear-gradient(135deg, #1e1b4b 0%, #2B2D6E 100%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(30,27,75,0.3);
        }

        .audio-toggle-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(30,27,75,0.4);
        }

        .audio-toggle-btn.active {
            background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
            box-shadow: 0 4px 12px rgba(255,107,53,0.3);
        }

        .call-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        }

        .call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16,185,129,0.4);
        }

        .hangup-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239,68,68,0.3);
            display: none;
        }

        .hangup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239,68,68,0.4);
        }

        /* Registro de llamadas */
        .call-log {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .call-log-empty {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-size: 14px;
        }

        .call-log-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .call-log-item:hover {
            background: #f1f5f9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transform: translateX(2px);
        }

        .call-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .call-icon.incoming {
            background: rgba(16,185,129,0.1);
            color: #10b981;
        }

        .call-icon.outgoing {
            background: rgba(59,130,246,0.1);
            color: #3b82f6;
        }

        .call-icon.missed {
            background: rgba(239,68,68,0.1);
            color: #ef4444;
        }

        .call-details {
            flex: 1;
        }

        .call-contact {
            font-weight: 600;
            color: #1e1b4b;
            font-size: 14px;
        }

        .call-number {
            font-size: 12px;
            color: #64748b;
        }

        .call-meta {
            text-align: right;
        }

        .call-time {
            font-size: 11px;
            color: #94a3b8;
        }

        .call-duration {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        /* Contactos mejorados */
        .contacts-content {
            padding: 15px;
        }

        .contacts-search {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            background: #f8fafc;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #FF6B35;
            background: white;
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .contacts-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .contact-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .contact-item:hover {
            background: #f1f5f9;
            border-color: #FF6B35;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .contact-info {
            flex: 1;
            cursor: pointer;
        }

        .contact-name {
            font-weight: 600;
            color: #1e1b4b;
            font-size: 14px;
        }

        .contact-number {
            color: #64748b;
            font-size: 12px;
            margin-top: 2px;
        }

        .contact-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .contact-type {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .contact-type.vip {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .contact-type.normal {
            background: #e5e7eb;
            color: #64748b;
        }

        .contact-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .contact-btn.edit {
            background: rgba(59,130,246,0.1);
            color: #3b82f6;
        }

        .contact-btn.edit:hover {
            background: #3b82f6;
            color: white;
        }

        .contact-btn.delete {
            background: rgba(239,68,68,0.1);
            color: #ef4444;
        }

        .contact-btn.delete:hover {
            background: #ef4444;
            color: white;
        }

        .add-contact-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255,107,53,0.2);
        }

        .add-contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,53,0.3);
        }

        /* Modal mejorado */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            margin: 80px auto;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #1e1b4b 0%, #2B2D6E 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-modal {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            width: 32px;
            height: 32px;
            border-radius: 10px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 20px;
        }

        /* Configuraci√≥n estilizada */
        .setting-group {
            margin-bottom: 15px;
        }

        .setting-group label {
            display: block;
            color: #1e1b4b;
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .setting-group input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            background: #f8fafc;
            transition: all 0.2s ease;
        }

        .setting-group input:focus {
            outline: none;
            border-color: #FF6B35;
            background: white;
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }

        .save-settings-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255,107,53,0.2);
        }

        .save-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,53,0.3);
        }

        /* Llamada entrante mejorada */
        .incoming-call-modal {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10001;
            min-width: 320px;
            overflow: hidden;
            animation: slideDownBounce 0.5s ease;
        }

        @keyframes slideDownBounce {
            0% {
                transform: translateY(-100px);
                opacity: 0;
            }
            60% {
                transform: translateY(10px);
                opacity: 1;
            }
            80% {
                transform: translateY(-5px);
            }
            100% {
                transform: translateY(0);
            }
        }

        .incoming-header {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .incoming-header h3 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .caller-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .caller-number {
            font-size: 24px;
            font-weight: 700;
        }

        .caller-name {
            font-size: 16px;
            opacity: 0.9;
        }

        .incoming-actions {
            display: flex;
            padding: 20px;
            gap: 12px;
            background: #f8fafc;
        }

        .answer-btn, .reject-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .answer-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        }

        .answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16,185,129,0.4);
        }

        .reject-btn {
            background: #e5e7eb;
            color: #64748b;
        }

        .reject-btn:hover {
            background: #d1d5db;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .phone-wrapper {
                right: -100%;
                top: auto;
                bottom: 0;
                transform: none;
                width: 100%;
            }

            .phone-wrapper.open {
                right: 0;
            }

            .phone-tab {
                display: none;
            }

            .phone-container {
                width: 100%;
                border-radius: 20px 20px 0 0;
            }
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="phone-wrapper" id="phoneWrapper">
        <div class="phone-tab" onclick="togglePhone()">
            <!-- SVG de Headset -->
            <svg class="headset-icon" viewBox="0 0 24 24" id="tabIcon">
                <path d="M12 1C7.03 1 3 5.03 3 10v7c0 1.66 1.34 3 3 3h1c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-2c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h1c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/>
                <path d="M7 14H5v4h2v-4zm10 0v4h2v-4h-2z"/>
            </svg>
            <span class="tab-text">Access</span>
        </div>
        
        <div class="phone-container">
            <div class="phone-header">
                <div class="header-top">
                    <div class="logo-section">
                        <div class="logo-door"></div>
                        <div class="logo-text">
                            <h1>ACCESS PHONE</h1>
                            <span>Asistentes Inteligentes</span>
                        </div>
                    </div>
                    <div class="header-buttons">
                        <button class="header-btn" onclick="openSettings()" title="Configuraci√≥n">‚öôÔ∏è</button>
                        <button class="header-btn" onclick="togglePhone()" title="Minimizar">‚àí</button>
                    </div>
                </div>
                <div class="connection-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Desconectado</span>
                </div>
            </div>

            <div class="phone-display">
                <div class="phone-number" id="phoneNumber"></div>
                <div class="call-info" id="callInfo">
                    <div class="call-timer" id="callTimer">00:00</div>
                    <div class="call-status" id="callStatus"></div>
                </div>
            </div>

            <!-- Panel de Control de Audio -->
            <div class="audio-controls" id="audioControls">
                <div class="audio-control-item">
                    <div class="audio-control-label">
                        <span>üéôÔ∏è Micr√≥fono</span>
                        <span id="micLevel">50%</span>
                    </div>
                    <input type="range" class="audio-slider" id="micSlider" min="0" max="100" value="50" 
                           oninput="updateMicVolume(this.value)">
                    <div class="volume-indicator" id="micIndicator">
                        <div class="volume-bar" style="height: 4px"></div>
                        <div class="volume-bar" style="height: 8px"></div>
                        <div class="volume-bar" style="height: 12px"></div>
                        <div class="volume-bar" style="height: 16px"></div>
                        <div class="volume-bar" style="height: 20px"></div>
                    </div>
                </div>

                <div class="audio-control-item">
                    <div class="audio-control-label">
                        <span>üîä Altavoz</span>
                        <span id="speakerLevel">75%</span>
                    </div>
                    <input type="range" class="audio-slider" id="speakerSlider" min="0" max="100" value="75"
                           oninput="updateSpeakerVolume(this.value)">
                </div>

                <div class="audio-control-item">
                    <div class="audio-control-label">
                        <span>üîî Tono de llamada</span>
                        <span id="ringtoneLevel">80%</span>
                    </div>
                    <input type="range" class="audio-slider" id="ringtoneSlider" min="0" max="100" value="80"
                           oninput="updateRingtoneVolume(this.value)">
                </div>

                <button class="mute-button" id="muteBtn" onclick="toggleMute()">
                    <span class="mute-icon">üéôÔ∏è</span>
                    <span id="muteText">Silenciar</span>
                </button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('dialpad')">
                    <span class="nav-tab-icon">üì±</span>
                    <span>Teclado</span>
                </button>
                <button class="nav-tab" onclick="switchTab('history')">
                    <span class="nav-tab-icon">üìã</span>
                    <span>Historial</span>
                </button>
                <button class="nav-tab" onclick="switchTab('contacts')">
                    <span class="nav-tab-icon">üë•</span>
                    <span>Contactos</span>
                </button>
            </div>

            <div id="dialpadTab" class="tab-content active">
                <div class="dialpad">
                    <button class="dial-btn" onclick="addDigit('1')">
                        1
                        <div class="letters"></div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('2')">
                        2
                        <div class="letters">ABC</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('3')">
                        3
                        <div class="letters">DEF</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('4')">
                        4
                        <div class="letters">GHI</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('5')">
                        5
                        <div class="letters">JKL</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('6')">
                        6
                        <div class="letters">MNO</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('7')">
                        7
                        <div class="letters">PQRS</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('8')">
                        8
                        <div class="letters">TUV</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('9')">
                        9
                        <div class="letters">WXYZ</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('*')">*</button>
                    <button class="dial-btn" onclick="addDigit('0')">
                        0
                        <div class="letters">+</div>
                    </button>
                    <button class="dial-btn" onclick="addDigit('#')">#</button>
                </div>

                <div class="action-buttons">
                    <button class="action-btn delete-btn" onclick="deleteDigit()">‚å´</button>
                    <button class="audio-toggle-btn" id="audioToggleBtn" onclick="toggleAudioControls()" title="Controles de Audio">
                        üéôÔ∏è
                    </button>
                    <button class="action-btn call-btn" id="callBtn" onclick="makeCall()">üìû</button>
                    <button class="action-btn hangup-btn" id="hangupBtn" onclick="hangupCall()">üìû</button>
                </div>
            </div>

            <div id="historyTab" class="tab-content">
                <div class="call-log" id="callLog">
                    <div class="call-log-empty" id="emptyLog">
                        No hay llamadas registradas
                    </div>
                </div>
            </div>

            <div id="contactsTab" class="tab-content">
                <div class="contacts-content">
                    <div class="contacts-search" style="position: relative;">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" placeholder="Buscar contacto..." onkeyup="searchContacts(this.value)">
                    </div>
                    <div class="contacts-list" id="contactsList">
                        <!-- Contactos se cargan aqu√≠ -->
                    </div>
                    <button class="add-contact-btn" onclick="showAddContact()">+ Agregar Contacto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Configuraci√≥n</h2>
                <button class="close-modal" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Servidor WebSocket (WSS)</label>
                    <input type="text" id="wsServer" placeholder="wss://accessbotpbx.info:8089/ws">
                </div>
                
                <div class="setting-group">
                    <label>Extensi√≥n</label>
                    <input type="text" id="sipExtension" placeholder="103">
                </div>
                
                <div class="setting-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="sipPassword" placeholder="Contrase√±a">
                </div>
                
                <div class="setting-group">
                    <label>Dominio SIP</label>
                    <input type="text" id="sipDomain" placeholder="accessbotpbx.info">
                </div>
                
                <button class="save-settings-btn" onclick="saveSettings()">Guardar y Conectar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Llamada Entrante -->
    <div class="incoming-call-modal" id="incomingModal">
        <div class="incoming-header">
            <h3>üìû Llamada Entrante</h3>
            <div class="caller-info">
                <div class="caller-number" id="callerNumber">Desconocido</div>
                <div class="caller-name" id="callerName"></div>
            </div>
        </div>
        <div class="incoming-actions">
            <button class="answer-btn" onclick="answerCall()">
                <span>‚úì</span> Contestar
            </button>
            <button class="reject-btn" onclick="rejectCall()">
                <span>‚úó</span> Rechazar
            </button>
        </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>
    <audio id="localAudio" autoplay muted></audio>
    <audio id="ringtone" loop>
        <source src="ringtone.mp3" type="audio/mpeg">
        <source src="ringtone.ogg" type="audio/ogg">
    </audio>

    <script>
        // Variables globales
        let ua = null;
        let currentSession = null;
        let phoneNumber = '';
        let callTimer = null;
        let callStartTime = null;
        let config = {};
        let contacts = [];
        let callHistory = [];
        let phoneOpen = false;
        let activeTab = 'dialpad';
        let isMuted = false;
        let audioSettings = {
            micVolume: 50,
            speakerVolume: 75,
            ringtoneVolume: 80
        };
        let localStream = null;
        let audioContext = null;
        let micAnalyser = null;

        // Verificar que JsSIP est√© cargado
        if (typeof JsSIP === 'undefined') {
            console.error('JsSIP no est√° cargado');
            alert('Error: No se pudo cargar la librer√≠a JsSIP');
        } else {
            console.log('JsSIP versi√≥n:', JsSIP.version);
        }

        // Toggle del tel√©fono
        function togglePhone() {
            const wrapper = document.getElementById('phoneWrapper');
            phoneOpen = !phoneOpen;
            
            if (phoneOpen) {
                wrapper.classList.add('open');
                wrapper.classList.remove('auto-hide');
            } else {
                wrapper.classList.remove('open');
                setTimeout(() => {
                    wrapper.classList.add('auto-hide');
                }, 3000);
            }
        }

        // Controles de Audio
        function toggleAudioControls() {
            const controls = document.getElementById('audioControls');
            const btn = document.getElementById('audioToggleBtn');
            
            if (controls.classList.contains('active')) {
                controls.classList.remove('active');
                btn.classList.remove('active');
            } else {
                controls.classList.add('active');
                btn.classList.add('active');
            }
        }

        function updateMicVolume(value) {
            audioSettings.micVolume = value;
            document.getElementById('micLevel').textContent = value + '%';
            
            // Aplicar volumen al stream local si existe
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    if (track.enabled) {
                        // Ajustar ganancia usando Web Audio API
                        if (!audioContext) {
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        }
                        // Aqu√≠ se aplicar√≠a la ganancia real
                    }
                });
            }
            
            // Animar indicador visual
            animateMicIndicator(value);
            saveAudioSettings();
        }

        function animateMicIndicator(level) {
            const bars = document.querySelectorAll('#micIndicator .volume-bar');
            const activeBars = Math.floor((level / 100) * bars.length);
            
            bars.forEach((bar, index) => {
                if (index < activeBars) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }

        function updateSpeakerVolume(value) {
            audioSettings.speakerVolume = value;
            document.getElementById('speakerLevel').textContent = value + '%';
            
            // Aplicar volumen al audio remoto
            const remoteAudio = document.getElementById('remoteAudio');
            remoteAudio.volume = value / 100;
            
            saveAudioSettings();
        }

        function updateRingtoneVolume(value) {
            audioSettings.ringtoneVolume = value;
            document.getElementById('ringtoneLevel').textContent = value + '%';
            
            // Aplicar volumen al tono de llamada
            const ringtone = document.getElementById('ringtone');
            ringtone.volume = value / 100;
            
            // Preview del tono
            if (value > 0) {
                ringtone.play();
                setTimeout(() => ringtone.pause(), 500);
            }
            
            saveAudioSettings();
        }

        function toggleMute() {
            isMuted = !isMuted;
            const muteBtn = document.getElementById('muteBtn');
            const muteIcon = muteBtn.querySelector('.mute-icon');
            const muteText = document.getElementById('muteText');
            
            if (isMuted) {
                muteBtn.classList.add('muted');
                muteIcon.textContent = 'üîá';
                muteText.textContent = 'Activar Micr√≥fono';
                
                // Silenciar micr√≥fono
                if (currentSession && localStream) {
                    localStream.getAudioTracks().forEach(track => {
                        track.enabled = false;
                    });
                }
            } else {
                muteBtn.classList.remove('muted');
                muteIcon.textContent = 'üéôÔ∏è';
                muteText.textContent = 'Silenciar';
                
                // Activar micr√≥fono
                if (currentSession && localStream) {
                    localStream.getAudioTracks().forEach(track => {
                        track.enabled = true;
                    });
                }
            }
        }

        function saveAudioSettings() {
            localStorage.setItem('webphoneAudioSettings', JSON.stringify(audioSettings));
        }

        function loadAudioSettings() {
            const saved = localStorage.getItem('webphoneAudioSettings');
            if (saved) {
                audioSettings = JSON.parse(saved);
                document.getElementById('micSlider').value = audioSettings.micVolume;
                document.getElementById('speakerSlider').value = audioSettings.speakerVolume;
                document.getElementById('ringtoneSlider').value = audioSettings.ringtoneVolume;
                updateMicVolume(audioSettings.micVolume);
                updateSpeakerVolume(audioSettings.speakerVolume);
                updateRingtoneVolume(audioSettings.ringtoneVolume);
            }
        }

        // Cambiar entre tabs
        function switchTab(tabName) {
            activeTab = tabName;
            
            // Actualizar tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activar tab seleccionado
            event.target.closest('.nav-tab').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Cargar contenido seg√∫n el tab
            if (tabName === 'history') {
                renderCallHistory();
            } else if (tabName === 'contacts') {
                renderContacts();
            }
        }

        // Auto-abrir cuando hay llamada entrante
        function showPhoneOnIncoming() {
            const wrapper = document.getElementById('phoneWrapper');
            wrapper.classList.add('open', 'ringing');
            phoneOpen = true;
            
            // Reproducir tono de llamada
            const ringtone = document.getElementById('ringtone');
            ringtone.volume = audioSettings.ringtoneVolume / 100;
            ringtone.play();
            
            // Cambiar el √≠cono del tab a tel√©fono sonando
            document.getElementById('tabIcon').innerHTML = `
                <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 0 0-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
            `;
            
            // Quitar animaci√≥n despu√©s de contestar/rechazar
            setTimeout(() => {
                wrapper.classList.remove('ringing');
            }, 30000);
        }

        // Cargar configuraci√≥n y datos guardados
        window.onload = function() {
            // Cargar configuraci√≥n
            const savedConfig = localStorage.getItem('webphoneConfig');
            if (savedConfig) {
                try {
                    config = JSON.parse(savedConfig);
                    document.getElementById('wsServer').value = config.wsServer || '';
                    document.getElementById('sipExtension').value = config.extension || '';
                    document.getElementById('sipPassword').value = config.password || '';
                    document.getElementById('sipDomain').value = config.domain || '';
                    
                    // Auto-conectar si hay configuraci√≥n
                    if (config.extension && config.password) {
                        setTimeout(connectToServer, 1000);
                    }
                } catch (e) {
                    console.error('Error cargando configuraci√≥n:', e);
                }
            }

            // Cargar contactos
            loadContacts();
            
            // Cargar historial
            loadCallHistory();
            
            // Cargar configuraci√≥n de audio
            loadAudioSettings();

            // Auto-hide inicial
            setTimeout(() => {
                document.getElementById('phoneWrapper').classList.add('auto-hide');
            }, 3000);
        };

        // Funciones de historial de llamadas
        function loadCallHistory() {
            const saved = localStorage.getItem('webphoneCallHistory');
            if (saved) {
                try {
                    callHistory = JSON.parse(saved);
                } catch (e) {
                    callHistory = [];
                }
            }
        }

        function saveCallHistory() {
            localStorage.setItem('webphoneCallHistory', JSON.stringify(callHistory));
        }

        function addToCallHistory(type, number, duration = null) {
            const contact = contacts.find(c => c.number === number);
            const entry = {
                id: Date.now(),
                type: type, // 'incoming', 'outgoing', 'missed'
                number: number,
                name: contact ? contact.name : null,
                duration: duration,
                date: new Date().toISOString()
            };
            
            callHistory.unshift(entry);
            
            // Mantener solo las √∫ltimas 50 llamadas
            if (callHistory.length > 50) {
                callHistory = callHistory.slice(0, 50);
            }
            
            saveCallHistory();
            
            if (activeTab === 'history') {
                renderCallHistory();
            }
        }

        function renderCallHistory() {
            const logContainer = document.getElementById('callLog');
            
            if (callHistory.length === 0) {
                logContainer.innerHTML = '<div class="call-log-empty">No hay llamadas registradas</div>';
                return;
            }
            
            logContainer.innerHTML = callHistory.map(call => {
                const date = new Date(call.date);
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                const timeStr = isToday ? 
                    date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }) :
                    date.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit' });
                
                const iconClass = call.type === 'incoming' ? 'incoming' : 
                                 call.type === 'outgoing' ? 'outgoing' : 'missed';
                const icon = call.type === 'incoming' ? 'üìû‚Üì' : 
                            call.type === 'outgoing' ? 'üìû‚Üë' : 'üìû‚úó';
                
                return `
                    <div class="call-log-item" onclick="callFromHistory('${call.number}')">
                        <div class="call-icon ${iconClass}">${icon}</div>
                        <div class="call-details">
                            <div class="call-contact">${call.name || formatPhoneNumber(call.number)}</div>
                            ${call.name ? `<div class="call-number">${formatPhoneNumber(call.number)}</div>` : ''}
                        </div>
                        <div class="call-meta">
                            <div class="call-time">${timeStr}</div>
                            ${call.duration ? `<div class="call-duration">${formatDuration(call.duration)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function callFromHistory(number) {
            phoneNumber = number;
            updateDisplay();
            switchTab('dialpad');
            makeCall();
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Funciones de contactos
        function loadContacts() {
            const savedContacts = localStorage.getItem('webphoneContacts');
            if (savedContacts) {
                try {
                    contacts = JSON.parse(savedContacts);
                } catch (e) {
                    contacts = [];
                }
            }
            
            // Contactos por defecto si no hay ninguno
            if (contacts.length === 0) {
                contacts = [
                    { name: 'Soporte T√©cnico', number: '101', type: 'normal' },
                    { name: 'Recepci√≥n', number: '100', type: 'normal' }
                ];
                saveContacts();
            }
        }

        function saveContacts() {
            localStorage.setItem('webphoneContacts', JSON.stringify(contacts));
        }

        function renderContacts(searchTerm = '') {
            const list = document.getElementById('contactsList');
            const filtered = contacts.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.number.includes(searchTerm)
            );

            if (filtered.length === 0) {
                list.innerHTML = '<div class="call-log-empty">No se encontraron contactos</div>';
                return;
            }

            list.innerHTML = filtered.map((contact, index) => `
                <div class="contact-item">
                    <div class="contact-info" onclick="callContact('${contact.number}')">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-number">${formatPhoneNumber(contact.number)}</div>
                    </div>
                    <div class="contact-actions">
                        <span class="contact-type ${contact.type}">${contact.type}</span>
                        <button class="contact-btn edit" onclick="editContact(${index})" title="Editar">‚úèÔ∏è</button>
                        <button class="contact-btn delete" onclick="deleteContact(${index})" title="Eliminar">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function editContact(index) {
            event.stopPropagation();
            const contact = contacts[index];
            const newName = prompt('Nombre del contacto:', contact.name);
            if (newName === null) return;
            
            const newNumber = prompt('N√∫mero de tel√©fono:', contact.number);
            if (newNumber === null) return;
            
            const newType = confirm('¬øEs un contacto VIP?') ? 'vip' : 'normal';
            
            contacts[index] = { name: newName, number: newNumber, type: newType };
            saveContacts();
            renderContacts();
        }

        function deleteContact(index) {
            event.stopPropagation();
            if (confirm('¬øEliminar este contacto?')) {
                contacts.splice(index, 1);
                saveContacts();
                renderContacts();
            }
        }

        function searchContacts(term) {
            renderContacts(term);
        }

        function callContact(number) {
            phoneNumber = number;
            updateDisplay();
            switchTab('dialpad');
            makeCall();
        }

        function showAddContact() {
            const name = prompt('Nombre del contacto:');
            if (!name) return;
            
            const number = prompt('N√∫mero de tel√©fono:');
            if (!number) return;
            
            const type = confirm('¬øEs un contacto VIP?') ? 'vip' : 'normal';
            
            contacts.push({ name, number, type });
            saveContacts();
            renderContacts();
        }

        function getContactName(number) {
            const contact = contacts.find(c => c.number === number);
            return contact ? contact.name : null;
        }

        // Funciones de UI
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            config = {
                wsServer: document.getElementById('wsServer').value || 'wss://accessbotpbx.info:8089/ws',
                extension: document.getElementById('sipExtension').value,
                password: document.getElementById('sipPassword').value,
                domain: document.getElementById('sipDomain').value || 'accessbotpbx.info'
            };
            
            if (!config.extension || !config.password) {
                alert('Por favor complete extensi√≥n y contrase√±a');
                return;
            }
            
            localStorage.setItem('webphoneConfig', JSON.stringify(config));
            closeSettings();
            connectToServer();
        }

        // Funciones del teclado
        function addDigit(digit) {
            phoneNumber += digit;
            updateDisplay();
            
            // Si hay una llamada activa, enviar DTMF
            if (currentSession && currentSession.isEstablished()) {
                currentSession.sendDTMF(digit);
            }
        }

        function deleteDigit() {
            phoneNumber = phoneNumber.slice(0, -1);
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('phoneNumber').textContent = formatPhoneNumber(phoneNumber);
        }

        function formatPhoneNumber(number) {
            if (!number) return '';
            if (number.length <= 3) return number;
            if (number.length <= 6) return number.slice(0, 3) + ' ' + number.slice(3);
            if (number.length <= 10) return number.slice(0, 2) + ' ' + number.slice(2, 6) + ' ' + number.slice(6);
            return number;
        }

        // Conexi√≥n con el servidor
        function connectToServer() {
            console.log('Iniciando conexi√≥n con configuraci√≥n:', config);
            
            if (!config.extension || !config.password) {
                updateStatus('Configuraci√≥n incompleta', false);
                return;
            }

            updateStatus('Conectando...', false);

            try {
                // Detener UA anterior si existe
                if (ua) {
                    ua.stop();
                    ua = null;
                }

                // Configuraci√≥n de JsSIP
                const socket = new JsSIP.WebSocketInterface(config.wsServer);
                
                const configuration = {
                    sockets: [socket],
                    uri: 'sip:' + config.extension + '@' + config.domain,
                    password: config.password,
                    register: true,
                    register_expires: 600,
                    session_timers: false,
                    user_agent: 'Access Phone v2.0'
                };

                console.log('Configuraci√≥n JsSIP:', configuration);

                // Crear User Agent
                ua = new JsSIP.UA(configuration);

                // Configurar eventos
                ua.on('connected', function() {
                    console.log('WebSocket conectado');
                    updateStatus('Registrando...', false);
                });

                ua.on('disconnected', function() {
                    console.log('WebSocket desconectado');
                    updateStatus('Desconectado', false);
                });

                ua.on('registered', function() {
                    console.log('Registrado exitosamente');
                    updateStatus('Conectado', true);
                });

                ua.on('unregistered', function() {
                    console.log('Desregistrado');
                    updateStatus('Desconectado', false);
                });

                ua.on('registrationFailed', function(e) {
                    console.error('Fallo en registro:', e);
                    updateStatus('Error de registro', false);
                });

                // Manejar llamadas entrantes
                ua.on('newRTCSession', function(e) {
                    const session = e.session;
                    
                    if (e.originator === 'remote') {
                        // Llamada entrante
                        handleIncomingCall(session);
                    }
                });

                // Iniciar conexi√≥n
                ua.start();
                
            } catch (error) {
                console.error('Error al conectar:', error);
                updateStatus('Error de conexi√≥n', false);
            }
        }

        // Actualizar estado de conexi√≥n
        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            if (connected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
        }

        // Realizar llamada
        function makeCall() {
            if (!ua || !ua.isRegistered()) {
                alert('No est√° conectado al servidor');
                return;
            }

            if (!phoneNumber) {
                alert('Ingrese un n√∫mero para llamar');
                return;
            }

            updateCallStatus('Llamando...');
            
            // Registrar llamada saliente
            const callId = Date.now();

            const eventHandlers = {
                'progress': function() {
                    updateCallStatus('Llamando...');
                },
                'failed': function(e) {
                    console.error('Llamada fall√≥:', e);
                    updateCallStatus('Llamada fall√≥');
                    addToCallHistory('outgoing', phoneNumber, 0);
                    endCall();
                },
                'ended': function() {
                    updateCallStatus('Llamada terminada');
                    const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
                    addToCallHistory('outgoing', phoneNumber, duration);
                    endCall();
                },
                'confirmed': function() {
                    updateCallStatus('En llamada');
                    startCallTimer();
                    document.getElementById('phoneWrapper').classList.add('in-call');
                }
            };

            const options = {
                eventHandlers: eventHandlers,
                mediaConstraints: { audio: true, video: false },
                rtcOfferConstraints: {
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: false
                }
            };

            // Agregar prefijo si es necesario
            let numberToCall = phoneNumber;
            if (phoneNumber.length === 10 && phoneNumber.startsWith('5')) {
                numberToCall = '52' + phoneNumber;
            }

            currentSession = ua.call('sip:' + numberToCall + '@' + config.domain, options);
            
            setupSessionEvents(currentSession);
            
            // Cambiar botones
            document.getElementById('callBtn').style.display = 'none';
            document.getElementById('hangupBtn').style.display = 'flex';
            
            // Mostrar info de llamada
            document.getElementById('callInfo').classList.add('active');
        }

        // Colgar llamada
        function hangupCall() {
            if (currentSession) {
                currentSession.terminate();
            }
            endCall();
        }

        // Manejar llamada entrante
        function handleIncomingCall(session) {
            currentSession = session;
            
            const remoteIdentity = session.remote_identity;
            const callerNumber = remoteIdentity.uri.user;
            
            // Buscar en contactos locales
            const contactName = getContactName(callerNumber);
            
            document.getElementById('callerNumber').textContent = formatPhoneNumber(callerNumber);
            if (contactName) {
                document.getElementById('callerName').textContent = contactName;
                document.getElementById('callerName').style.display = 'block';
            } else {
                document.getElementById('callerName').style.display = 'none';
            }
            
            document.getElementById('incomingModal').style.display = 'block';
            
            // Mostrar el tel√©fono
            showPhoneOnIncoming();
            
            setupSessionEvents(session);
            
            session.on('failed', function() {
                document.getElementById('incomingModal').style.display = 'none';
                document.getElementById('phoneWrapper').classList.remove('ringing');
                document.getElementById('ringtone').pause();
                addToCallHistory('missed', callerNumber);
            });
            
            session.on('ended', function() {
                document.getElementById('incomingModal').style.display = 'none';
                document.getElementById('phoneWrapper').classList.remove('ringing');
                document.getElementById('ringtone').pause();
                const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
                if (duration > 0) {
                    addToCallHistory('incoming', callerNumber, duration);
                }
                endCall();
            });
        }

        // Contestar llamada
        function answerCall() {
            if (currentSession) {
                const options = {
                    mediaConstraints: { audio: true, video: false }
                };
                
                currentSession.answer(options);
                document.getElementById('incomingModal').style.display = 'none';
                document.getElementById('phoneWrapper').classList.remove('ringing');
                document.getElementById('ringtone').pause();
                
                updateCallStatus('En llamada');
                startCallTimer();
                document.getElementById('phoneWrapper').classList.add('in-call');
                
                // Cambiar botones
                document.getElementById('callBtn').style.display = 'none';
                document.getElementById('hangupBtn').style.display = 'flex';
                
                // Mostrar info de llamada
                document.getElementById('callInfo').classList.add('active');
            }
        }

        // Rechazar llamada
        function rejectCall() {
            if (currentSession) {
                currentSession.terminate();
                const callerNumber = currentSession.remote_identity.uri.user;
                addToCallHistory('missed', callerNumber);
            }
            document.getElementById('incomingModal').style.display = 'none';
            document.getElementById('phoneWrapper').classList.remove('ringing');
            document.getElementById('ringtone').pause();
        }

        // Configurar eventos de sesi√≥n
        function setupSessionEvents(session) {
            // Manejar streams de audio
            session.on('peerconnection', function(e) {
                const pc = e.peerconnection;
                
                // Manejar audio remoto
                pc.addEventListener('track', function(event) {
                    const remoteAudio = document.getElementById('remoteAudio');
                    remoteAudio.srcObject = event.streams[0];
                    remoteAudio.volume = audioSettings.speakerVolume / 100;
                });
                
                // Obtener stream local para control de volumen
                pc.addEventListener('addstream', function(event) {
                    if (event.stream && event.stream.getAudioTracks().length > 0) {
                        localStream = event.stream;
                        
                        // Aplicar configuraci√≥n de micr√≥fono
                        if (isMuted) {
                            localStream.getAudioTracks().forEach(track => {
                                track.enabled = false;
                            });
                        }
                        
                        // Configurar analizador de audio para visualizaci√≥n
                        if (!audioContext) {
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        }
                        
                        const source = audioContext.createMediaStreamSource(localStream);
                        micAnalyser = audioContext.createAnalyser();
                        micAnalyser.fftSize = 256;
                        source.connect(micAnalyser);
                        
                        // Iniciar visualizaci√≥n del micr√≥fono
                        visualizeMic();
                    }
                });
            });
        }

        // Visualizaci√≥n del nivel de micr√≥fono
        function visualizeMic() {
            if (!micAnalyser || !currentSession) return;
            
            const dataArray = new Uint8Array(micAnalyser.frequencyBinCount);
            micAnalyser.getByteFrequencyData(dataArray);
            
            // Calcular nivel promedio
            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const level = Math.min(100, (average / 128) * 100);
            
            // Actualizar indicador visual
            animateMicIndicator(level);
            
            // Continuar animaci√≥n
            if (currentSession && currentSession.isEstablished()) {
                requestAnimationFrame(visualizeMic);
            }
        }

        // Funciones auxiliares
        function updateCallStatus(status) {
            document.getElementById('callStatus').textContent = status;
        }

        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(function() {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('callTimer').textContent = minutes + ':' + seconds;
            }, 1000);
        }

        function endCall() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            phoneNumber = '';
            updateDisplay();
            updateCallStatus('');
            
            document.getElementById('callInfo').classList.remove('active');
            document.getElementById('callTimer').textContent = '00:00';
            document.getElementById('callBtn').style.display = 'flex';
            document.getElementById('hangupBtn').style.display = 'none';
            document.getElementById('phoneWrapper').classList.remove('in-call');
            
            // Restaurar bot√≥n de mute
            isMuted = false;
            const muteBtn = document.getElementById('muteBtn');
            muteBtn.classList.remove('muted');
            muteBtn.querySelector('.mute-icon').textContent = 'üéôÔ∏è';
            document.getElementById('muteText').textContent = 'Silenciar';
            
            // Limpiar referencias
            currentSession = null;
            callStartTime = null;
            localStream = null;
            micAnalyser = null;
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Manejar teclas del teclado
        document.addEventListener('keydown', function(e) {
            // Solo funcionar si el tel√©fono est√° abierto
            if (!phoneOpen) return;
            
            if (e.key >= '0' && e.key <= '9') {
                addDigit(e.key);
            } else if (e.key === '*' || e.key === '#') {
                addDigit(e.key);
            } else if (e.key === 'Backspace') {
                deleteDigit();
            } else if (e.key === 'Enter' && phoneNumber) {
                makeCall();
            } else if (e.key === 'Escape' && currentSession) {
                hangupCall();
            } else if (e.key === 'm' || e.key === 'M') {
                // Atajo para mute
                if (currentSession && currentSession.isEstablished()) {
                    toggleMute();
                }
            }
        });
    </script>
</body>
</html>
